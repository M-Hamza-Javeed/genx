<div id="page0" style="position:relative;width:540pt;height:648pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:32pt;left:209pt"><span style="font-family:Times,serif;font-size:9.963pt">Chapter 7. Multiprogramming</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:97pt;left:72pt"><b><span style="font-family:Helvetica,sans-serif;font-size:11.955pt">Case Study: Backup Scripts</span></b></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:122pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Specialization wrappers are a classic use of the Unix shell and other scripting languages. One kind</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:134pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">of specialization wrapper that is both common and representative is a backup script. It may be a</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:146pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">one-liner as simple as this:</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:179pt;left:72pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">tar -czvf /dev/st0 &quot;$@&quot;</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:210pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">This is a wrapper for the tar(1) tape archiver utility which simply supplies one &#xfb01;xed argument (the</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:222pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">tape device</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> /dev/st0</span></tt><span style="font-family:Times,serif;font-size:9.963pt">) and passes to tar all the other arguments supplied by the user (&#x201c;</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt">$@</span></tt><span style="font-family:Times,serif;font-size:9.963pt">&#x201d;).</span><sup><span style="font-family:Times,serif;font-size:6.273pt">71</span></sup></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:244pt;left:72pt"><b><span style="font-family:Helvetica,sans-serif;font-size:13.948pt">Security Wrappers and Bernstein Chaining</span></b></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:270pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">One common use of wrapper scripts is as</span><i><span style="font-family:Times,serif;font-size:9.963pt"> security wrappers</span></i><span style="font-family:Times,serif;font-size:9.963pt">. A security script may call a gatekeeper</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:282pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">program to check some sort of credential, then conditionally execute another based on the status</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:294pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">value returned by the gatekeeper.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:316pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Bernstein chaining is a specialized security-wrapper technique &#xfb01;rst invented by Daniel J. Bernstein,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:328pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">who has employed it in a number of his packages. (A similar pattern appears in commands like</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:340pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">nohup(1) and su(1), but the conditionality is absent.)</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:340pt;left:301pt"><span style="font-family:Times,serif;font-size:9.963pt">Conceptually, a Bernstein chain is like a</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:352pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">pipeline, but each successive stage replaces the previous one rather than running concurrently with</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:364pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">it.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:386pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">The usual application is to con&#xfb01;ne security-privileged applications to some sort of gatekeeper</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:398pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">program, which can then hand state to a less privileged one. The technique pastes several programs</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:410pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">together using execs, or possibly a combination of forks and execs. The programs are all named on</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:422pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">one command line. Each program performs some function and (if successful) runs exec(2) on the</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:434pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">rest of its command line.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:456pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Bernstein&#x2019;s</span><i><span style="font-family:Times,serif;font-size:9.963pt"> rblsmtpd</span></i><span style="font-family:Times,serif;font-size:9.963pt"> package is a prototypical example. It serves to look up a host in the antispam</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:468pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">DNS zone of the Mail Abuse Prevention System. It does this by doing a DNS query on the IP address</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:480pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">passed into it in the</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> TCPREMOTEIP</span></tt><span style="font-family:Times,serif;font-size:9.963pt"> environment variable. If the query is successful, then</span><i><span style="font-family:Times,serif;font-size:9.963pt"> rblsmtpd</span></i></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:492pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">runs its own SMTP that discards the mail. Otherwise the remaining command-line arguments are</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:503pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">presumed to constitute a mail transport agent that knows the SMTP protocol, and are handed to</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:515pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">exec(2) to be run.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:535pt;left:72pt"><span style="font-family:Times,serif;font-size:5.018pt">71</span><span style="font-family:Times,serif;font-size:7.97pt">A common error is to use</span><tt><span style="font-family:Courier,monospace;font-size:7.173pt"> $*</span></tt><span style="font-family:Times,serif;font-size:7.97pt"> rather than &#x201c;</span><tt><span style="font-family:Courier,monospace;font-size:7.173pt">$@</span></tt><span style="font-family:Times,serif;font-size:7.97pt">&#x201d;. This does bad things when handed a &#xfb01;lename with embedded spaces.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:581pt;left:262pt"><span style="font-family:Times,serif;font-size:9.963pt">198</span></p>
</div>
