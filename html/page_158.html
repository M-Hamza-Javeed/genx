<div id="page0" style="position:relative;width:612pt;height:792pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:95pt;left:108pt"><i><span style="font-family:BookAntiqua,serif;font-size:9pt">Precompiling Templates on the Server Side</span></i></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:666pt;left:293pt"><b><span style="font-family:Arial,sans-serif;font-size:9pt">[</span></b><b><span style="font-family:Arial,sans-serif;font-size:8pt"> 142 </span></b><b><span style="font-family:Arial,sans-serif;font-size:9pt">]</span></b></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:115pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  tplName,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:139pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  // create a string which when evaluated will create the </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:152pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  // template object with cachedTemplates</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:164pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  compiledTemplateStr = &apos;var Templates = {cachedTemplates : {}}; </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:175pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">\n\n&apos;;</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:199pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">// Iterate through all the templates in templates directory</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:211pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">fs.readdirSync(templateDir).forEach(function (tplFile) {</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:236pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  // Read the template and store the string in a variable</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:248pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  template = fs.readFileSync(templateDir + tplFile, &apos;utf8&apos;);</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:272pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  // Get the template name</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:285pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  tplName = tplFile.substr(0, tplFile.lastIndexOf(&apos;.&apos;));</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:309pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  // Add template function&apos;s source to cachedTemplate</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:321pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  compiledTemplateStr += &apos;Templates.cachedTemplates[&quot;&apos; + tplName + &apos;&quot;] </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:332pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">= &apos;;</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:344pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">  compiledTemplateStr += _.template(template).source + &apos;\n\n&apos;;</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:357pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">});</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:381pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">// Write all the compiled code in another file</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:393pt;left:126pt"><span style="font-family:CourierStd,serif;font-size:9pt">fs.writeFile(&apos;compiled.js&apos;, compiledTemplateStr, &apos;utf8&apos;);</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:413pt;left:108pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">The preceding code is pretty self-explanatory. We created a complete JavaScript </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:425pt;left:108pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">snippet as a string that will be returned to the frontend. Here are the steps to do so:</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:447pt;left:125pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">1. </span><span style="font-family:BookAntiqua,serif;font-size:10.5pt">First, we browse through each template file in the </span><span style="font-family:CourierStd,serif;font-size:9.5pt">templates</span><span style="font-family:BookAntiqua,serif;font-size:10.5pt"> directory and </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:459pt;left:144pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">retrieve their contents.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:476pt;left:126pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">2. We already have an object </span><span style="font-family:CourierStd,serif;font-size:9.5pt">Templates.cachedTemplates</span><span style="font-family:BookAntiqua,serif;font-size:10.5pt"> defined and we </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:489pt;left:144pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">need to store each template file&apos;s contents in this object with the template </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:501pt;left:144pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">filename as a property and the template string as its value.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:518pt;left:126pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">3. Underscore&apos;s </span><span style="font-family:CourierStd,serif;font-size:9.5pt">_.template()</span><span style="font-family:BookAntiqua,serif;font-size:10.5pt"> method, in general, returns a function. It also </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:531pt;left:143pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">provides a property called </span><span style="font-family:CourierStd,serif;font-size:9.5pt">source</span><span style="font-family:BookAntiqua,serif;font-size:10.5pt"> that gives the textual representation of that </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:543pt;left:143pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">particular function. The following line will give you the function source code:</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:560pt;left:144pt"><span style="font-family:CourierStd,serif;font-size:9pt">_.template(template).source</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:580pt;left:126pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">4. We place all of the function strings inside </span><span style="font-family:CourierStd,serif;font-size:9.5pt">Templates.cachedTemplates</span><span style="font-family:BookAntiqua,serif;font-size:10.5pt"> one </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:592pt;left:144pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">by one, and once the loop is over, we write the entire contents to another </span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:605pt;left:144pt"><span style="font-family:BookAntiqua,serif;font-size:10.5pt">JavaScript file.</span></p>
</div>
