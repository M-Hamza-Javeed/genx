<div id="page0" style="position:relative;width:540pt;height:648pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:32pt;left:219pt"><span style="font-family:Times,serif;font-size:9.963pt">Chapter 12. Optimization</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:100pt;left:108pt"><span style="font-family:Times,serif;font-size:9.963pt">and &#x201c;out of memory&#x201d;.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:100pt;left:204pt"><span style="font-family:Times,serif;font-size:9.963pt">The data shows us this effect even if weren&#x2019;t looking for</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:112pt;left:108pt"><span style="font-family:Times,serif;font-size:9.963pt">it, just by looking at the deviations from the best &#xfb01;t.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:124pt;left:422pt"><span style="font-family:Times,serif;font-size:9.963pt">&#x2014;</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:136pt;left:301pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">&lt;author&gt;SteveJohnson&lt;/author&gt;</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:168pt;left:71pt"><b><span style="font-family:Helvetica,sans-serif;font-size:15.94pt">Nonlocality Considered Harmful</span></b></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:197pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">The most effective way to optimize your code is to keep it small and simple. We&#x2019;ve been through</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:209pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">lots of good reasons to keep it small and simple earlier in this book.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:209pt;left:354pt"><span style="font-family:Times,serif;font-size:9.963pt">Here&#x2019;s a new one: you want</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:221pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">the central data structures and the time-critical loops in your code never to fall out of cache.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:242pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">Consider your target machine as a hierarchy of memory types arranged by distance from the</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:254pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">processor.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:254pt;left:126pt"><span style="font-family:Times,serif;font-size:9.963pt">There are the processor&#x2019;s own registers; its instruction pipeline; the level-one (L1)</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:266pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">cache; the level-two (L2) cache; possibly a level-three (L3) cache; main memory (what Unix old</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:278pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">hands still quaintly call &#x2018;core&#x2019;); and the disk drives where swap space lives. Technologies like SMP,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:290pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">shared-memory clusters, and non-uniform memory access (NUMA) add more layers to the picture</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:302pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">but only widen the overall spread.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:324pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">Every kind of access to that stack is getting faster. Processor cycles are almost free, outside of</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:336pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">a few demanding applications like modeling nuclear explosions or real-time video compression.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:348pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">But what&#x2019;s also happening is that the speed ratios between layers in the storage hierarchy are all</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:360pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">increasing as processor speeds go up. Thus, the relative cost of a cache miss is increasing.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:382pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">So we have an interesting paradox. As machine resources plummet, the expected cost of large data</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:394pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">structures falls &#x2014; but because the cost spread between adjacent cache levels is also going up, the</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:406pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">performance impact of being just large enough to break a cache boundary is also rising.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:428pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">&#x201c;Small is beautiful&#x201d; is therefore better advice than ever, particularly with regard to central data</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:440pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">structures that must live in the fastest possible cache.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:440pt;left:305pt"><span style="font-family:Times,serif;font-size:9.963pt">The advice applies to code as well; the</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:452pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">average instruction spends more time being loaded than it does executing.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:474pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">This turns some traditional advice on its head.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:474pt;left:266pt"><span style="font-family:Times,serif;font-size:9.963pt">Compiler optimizations like loop unrolling, which</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:486pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">get rid of relatively expensive machine instructions in return for an increase in total code size, may</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:497pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">no longer be worth doing.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:497pt;left:184pt"><span style="font-family:Times,serif;font-size:9.963pt">Another example is precomputing small tables &#x2014; for example, a table</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:509pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">of sin(x) by degree for optimizing rotations in a 3D graphics engine will take 365 &#xd7; 4 bytes on a</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:521pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">modern machine.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:521pt;left:150pt"><span style="font-family:Times,serif;font-size:9.963pt">Before processors got enough faster than memory to demand caching, this was</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:581pt;left:262pt"><span style="font-family:Times,serif;font-size:9.963pt">330</span></p>
</div>
