<div id="page0" style="position:relative;width:540pt;height:648pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:32pt;left:219pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">Chapter 12. Optimization</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:100pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">One way to minimize the effects of these noise sources, and get a better picture of where the time</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:112pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">is going in the average case, is to add together the results from a lot of pro&#xfb01;ling runs.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:112pt;left:429pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">There are</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:124pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">a lot of good reasons to build test harnesses and test loads for your programs before you get to</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:136pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">optimizing; the most important reason, usually far more important than performance tuning, is so</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:148pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">you can regression-test your program for correctness as you change it.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:148pt;left:373pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">Once you&#x2019;ve done this,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:160pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">being able to pro&#xfb01;le repeated tests under load is a nice side effect that will often give you better</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:172pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">information than a few runs by hand.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:193pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">Various effects tend to allocate time spent to calling routines rather than callees, overweighting upper</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:205pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">modes in the call graph. Function-call overhead, for example, is often charged to the calling routine</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:217pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">(whether or not this is true depends partly on your machine architecture and where the pro&#xfb01;ler is</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:229pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">allowed to insert probes). Macros and inline functions, if your compiler supports them, won&#x2019;t show</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:241pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">up in the pro&#xfb01;ling report at all; every bit of their time gets charged to the calling function.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:263pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">More importantly, many time-reporting tools give a display in which time spent in subroutines is</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:275pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">charged to the caller. (The gprof(1) pro&#xfb01;ler distributed with open-source Unixes has this trait.)</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:287pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">Na&#xef;vely subtracting callee time from caller time won&#x2019;t give you a useful result if the same routine can</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:299pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">have more than one caller &#x2014; the effect would be to arti&#xfb01;cially de&#xfb02;ate both callers&#x2019; times. Especially</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:311pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">nasty is the common case of a utility function with multiple call sites, some of which make lots of</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:323pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">trivial calls and others of which make a few complicated ones.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:345pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">To get more transparent results, factor your code so that upper-level routines consist as much as</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:357pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">possible of calls to lower-level routines, rather than in-line code. If you keep the overhead of upper-</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:369pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">level control logic to a minimum, the call structure of the code will tend to organize the pro&#xfb01;le report</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:381pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">in a way that is relatively easy to read.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:403pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">You&#x2019;ll get more insight from using pro&#xfb01;lers if you think of them less as ways to collect individual</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:415pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">performance numbers, and more as ways to learn how performance varies as a function of interesting</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:427pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">parameters (e.g., problem size, CPU speed, disc speed, memory size, compiler optimization, or</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:439pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">whatever else is relevant). Try &#xfb01;tting those numbers to a model, using open-source software like R</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:450pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">or a good-quality proprietary tool like MATLAB.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:472pt;left:108pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">The natural smoothing of the data that results from model &#xfb01;tting tends to focus on</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:484pt;left:108pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">the big effects and cover up the small, noisy ones. For example, by &#xfb01;tting a cubic</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:496pt;left:108pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">to the matrix inversion routine in MATLAB on random matrices from 10 &#xd7; 10 to</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:508pt;left:108pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">1000 &#xd7; 1000, it is clear that we actually have three cubics, with clearly de&#xfb01;ned</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:520pt;left:108pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">boundaries, that correspond roughly to &#x201c;in cache&#x201d;, &#x201c;in memory but out of cache&#x201d;,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:581pt;left:262pt"><span style="font-family:Times,serif;font-size:9.963pt;color:#ff0000">329</span></p>
</div>
