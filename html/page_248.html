<div id="page0" style="position:relative;width:540pt;height:648pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:32pt;left:218pt"><span style="font-family:Times,serif;font-size:9.963pt">Chapter 8. Minilanguages</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:100pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">In general, interactions between macros and expressions with side effects can lead to unfortunate</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:112pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">results that are hard to diagnose. C&#x2019;s macro processor is a deliberately lightweight and simple one;</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:124pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">more powerful ones can actually get you in worse trouble.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:146pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">The</span><i><span style="font-family:Times,serif;font-size:9.963pt"> TeX</span></i><span style="font-family:Times,serif;font-size:9.963pt"> formatting language (see Chapter 18) well illustrates the general problem.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:146pt;left:441pt"><i><span style="font-family:Times,serif;font-size:9.963pt">TeX</span></i><span style="font-family:Times,serif;font-size:9.963pt"> is</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:158pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">intentionally Turing-complete (it has conditionals, loops, and recursion), but while it can be made to</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:170pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">do amazing things,</span><i><span style="font-family:Times,serif;font-size:9.963pt"> TeX</span></i><span style="font-family:Times,serif;font-size:9.963pt"> code tends to be unreadable and painful to debug. The sources for</span><i><span style="font-family:Times,serif;font-size:9.963pt"> LaTeX</span></i><span style="font-family:Times,serif;font-size:9.963pt">,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:181pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">the the most widely used</span><i><span style="font-family:Times,serif;font-size:9.963pt"> TeX</span></i><span style="font-family:Times,serif;font-size:9.963pt"> macro package, are an instructive example: they&#x2019;re in very good</span><i><span style="font-family:Times,serif;font-size:9.963pt"> TeX</span></i></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:193pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">style, but even so are extremely dif&#xfb01;cult to follow.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:215pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">A minor problem, compared to this one, is that macro expansion tends to screw up error diagnostics.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:227pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">The base language processor generates its error reports relative to the macro expanded text, not the</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:239pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">original the programmer is looking at. If the relationship between the two has been obfuscated by</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:251pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">macro expansion, the emitted diagnostic can be very dif&#xfb01;cult to associate with the actual location of</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:263pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">the error.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:285pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">This is especially a problem with preprocessors and macros that can have multiline expansions,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:297pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">conditionally include or exclude text, or otherwise change line numbers in the expanded text.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:319pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">Macro expansion stages that are built into a language can do their own compensation, &#xfb01;ddling line</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:331pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">numbers to refer back to the preexpanded text. The macro facility in pic(1) does this, for example.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:343pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">This problem is more dif&#xfb01;cult to solve when the macro expansion is done by a preprocessor.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:365pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">The C preprocessor addresses this problem by emitting</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> #line</span></tt><span style="font-family:Times,serif;font-size:9.963pt"> directives whenever it does an</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:377pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">inclusion or multiline expansion. The C compiler is expected to interpret these and adjust the line</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:389pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">numbers in its error reports accordingly. Unfortunately,</span><i><span style="font-family:Times,serif;font-size:9.963pt"> m4</span></i><span style="font-family:Times,serif;font-size:9.963pt"> has no such facility.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:411pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">These are reasons to use macro expansion with extreme caution. One of the long-term lessons of</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:423pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">the Unix experience is that macros tend to create more problems than they solve. Modern language</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:435pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">and minilanguage designs have moved away from them.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:457pt;left:71pt"><b><span style="font-family:Helvetica,sans-serif;font-size:13.948pt">Language or Application Protocol?</span></b></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:483pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">Another important question you need to ask is whether your minilanguage engine will be called</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:495pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">interactively by other programs, as a slave process.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:495pt;left:289pt"><span style="font-family:Times,serif;font-size:9.963pt">If so, your design should probably look less</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:507pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">like a conversational language for human interaction and more like the kind of application protocols</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:519pt;left:71pt"><span style="font-family:Times,serif;font-size:9.963pt">we looked at in Chapter 5.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:581pt;left:262pt"><span style="font-family:Times,serif;font-size:9.963pt">247</span></p>
</div>
