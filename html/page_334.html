<div id="page0" style="position:relative;width:540pt;height:648pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:32pt;left:219pt"><span style="font-family:Times,serif;font-size:9.963pt">Chapter 12. Optimization</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:100pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">In Chapter 5 we compared the POP3 and IMAP protocols for querying remote-mail servers.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:100pt;left:454pt"><span style="font-family:Times,serif;font-size:9.963pt">We</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:112pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">noted that IMAP requests (unlike POP3 requests) are tagged with a request identi&#xfb01;er generated by</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:124pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">the client; the server, when it ships back a response, includes the tag of the request it pertains to.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:146pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">POP3 requests have to be processed in lockstep by both client and server; the client sends a request,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:158pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">waits for the response to that request, and only then can prepare and ship the next one.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:158pt;left:443pt"><span style="font-family:Times,serif;font-size:9.963pt">IMAP</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:170pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">requests, on the other hand, are are tagged so they can be overlapped. If an IMAP client knows that</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:181pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">it wants to fetch multiple messages, it can stream several fetch requests (each with a different tag)</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:193pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">to the IMAP server, without waiting for responses between them.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:193pt;left:350pt"><span style="font-family:Times,serif;font-size:9.963pt">Responses, each tagged, will</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:205pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">come back when the server is ready; responses to early requests may come in while the client is still</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:217pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">shipping later ones.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:239pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">This strategy is general to more areas than network protocols. If you want to cut latency, blocking</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:251pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">or waiting on intermediate results is deadly.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:273pt;left:72pt"><b><span style="font-family:Helvetica,sans-serif;font-size:13.948pt">Caching Operation Results</span></b></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:300pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Sometimes you can get the best of both worlds (low latency and good throughput) by computing</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:312pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">expensive results as needed and caching them for later use.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:312pt;left:330pt"><span style="font-family:Times,serif;font-size:9.963pt">Earlier we mentioned that</span><i><span style="font-family:Times,serif;font-size:9.963pt"> named</span></i></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:324pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">reduces latency by batching; it also reduces latency by caching the results of previous network</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:336pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">transactions with other DNS servers.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:358pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Caching has its own problems and tradeoffs, which are well illustrated by one application: the use</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:370pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">of binary caches to eliminate parsing overhead associated with text database &#xfb01;les. Some variants of</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:382pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Unix have used this technique to speed up access to their password information (the usual motivation</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:393pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">was to cut latency on logins at very large sites).</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:415pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">To make this work, all code that looks at the binary cache has to know that it should check the</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:427pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">timestamps on both &#xfb01;les and regenerate the cache if the text master is newer.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:427pt;left:400pt"><span style="font-family:Times,serif;font-size:9.963pt">Alternatively, all</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:439pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">changes to the textual master must be made through a wrapper that will update the binary format.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:461pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">While this approach can be made to work, it has all the disadvantages that the SPOT rule would</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:473pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">lead us to expect.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:473pt;left:151pt"><span style="font-family:Times,serif;font-size:9.963pt">The duplication of data means that it doesn&#x2019;t yield any economy of storage &#x2014;</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:485pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">it&#x2019;s purely a speed optimization. But the real problem with it is that the code to ensure coherency</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:497pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">between cache and master is notoriously leaky and bug-prone. Very frequently updated cache &#xfb01;les</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:509pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">can lead to subtle race conditions simply because of the 1-second resolution of timestamps.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:581pt;left:262pt"><span style="font-family:Times,serif;font-size:9.963pt">333</span></p>
</div>
