<div id="page0" style="position:relative;width:540pt;height:648pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:32pt;left:219pt"><span style="font-family:Times,serif;font-size:9.963pt">Chapter 12. Optimization</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:100pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Another very constructive form of doing nothing is to not write code. The program can&#x2019;t be slowed</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:112pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">down by code that isn&#x2019;t there. It can be slowed down by code that</span><i><span style="font-family:Times,serif;font-size:9.963pt"> is</span></i><span style="font-family:Times,serif;font-size:9.963pt"> there but less ef&#xfb01;cient than it</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:124pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">could be &#x2014; but that&#x2019;s a different matter.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:146pt;left:72pt"><b><span style="font-family:Helvetica,sans-serif;font-size:15.94pt">Measure before Optimizing</span></b></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:175pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">When you have real-world evidence that your application is too slow, then (and</span><i><span style="font-family:Times,serif;font-size:9.963pt"> only</span></i><span style="font-family:Times,serif;font-size:9.963pt"> then) is the time</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:187pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">to think about optimizing the code. But before you do more than think about optimizing, measure.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:209pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Recall Rob Pike&#x2019;s six rules in Chapter 1.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:209pt;left:246pt"><span style="font-family:Times,serif;font-size:9.963pt">One of the lessons that the original Unix programmers</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:221pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">learned early is that intuition is a poor guide to where the bottlenecks are, even for one who knows</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:232pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">the code in question intimately. Unixes, unlike most other operating systems, usually come with</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:244pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">pro&#xfb01;lers; use them.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:266pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Reading pro&#xfb01;ler results is something of an art.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:266pt;left:289pt"><span style="font-family:Times,serif;font-size:9.963pt">There are a couple of recurring problems:</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:278pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">one is instrumentation noise, another is the effect of imposed external latencies, and a third is</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:290pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">overweighting of upper nodes in the call graph.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:312pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">The instrumentation-noise problem is fundamental.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:312pt;left:290pt"><span style="font-family:Times,serif;font-size:9.963pt">Pro&#xfb01;lers work by inserting instructions that</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:324pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">report execution time at the entry and exit points of subroutines, also at &#xfb01;xed intervals within the</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:336pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">inline code of routines. These instructions themselves take time to execute. The effect is to reduce</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:348pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">the dispersion of call times: very short subroutines tend to look more expensive than they are, with</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:360pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">a lot of noise in their comparative call times, while for longer ones the instrumentation overhead is</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:372pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">invisible.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:394pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Bearing instrumentation noise in mind, it&#x2019;s wise to assume that the times listed for the fastest,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:406pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">shortest subroutines are going to have a lot of froth and air in them.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:406pt;left:363pt"><span style="font-family:Times,serif;font-size:9.963pt">They can still be eating a</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:418pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">lot of time if they are called very frequently, however, so pay particular attention to their call-count</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:430pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">statistics.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:452pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">The external-latency problem is also fundamental.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:452pt;left:282pt"><span style="font-family:Times,serif;font-size:9.963pt">There are various sorts of delay and distortion</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:464pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">that can happen behind the pro&#xfb01;ler&#x2019;s back. The simplest is overhead from operations with unpre-</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:476pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">dictable latency &#x2014; disk and network accesses, cache &#xfb01;lls, process-context switches, and the like.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:488pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">The problem is not so much that these overheads happen &#x2014; they may actually be what you&#x2019;re trying</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:499pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">to measure, especially if you&#x2019;re focusing on whole-system performance rather than just tuning a</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:511pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">critical inner loop. The problem is that they have a random component that means the results from</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:523pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">any individual pro&#xfb01;ling run may not be very useful.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:581pt;left:262pt"><span style="font-family:Times,serif;font-size:9.963pt">328</span></p>
</div>
