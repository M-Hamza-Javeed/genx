<div id="page0" style="position:relative;width:540pt;height:648pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:32pt;left:218pt"><span style="font-family:Times,serif;font-size:9.963pt">Chapter 8. Minilanguages</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:95pt;left:72pt"><b><span style="font-family:Helvetica,sans-serif;font-size:13.948pt">Macros &#x2014; Beware!</span></b></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:121pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Macro expansion facilities were a favored tactic for language designers in early Unix; the C language</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:133pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">has one, of course, and we have seen them show up in some of the more complex special-purpose</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:145pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">minilanguages like pic(1). The</span><i><span style="font-family:Times,serif;font-size:9.963pt"> m4</span></i><span style="font-family:Times,serif;font-size:9.963pt"> preprocessor provides a generic tool for implementing macro-</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:157pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">expanding preprocessors.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:179pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Macro expansion is easy to specify and implement, and you can do a lot of cute tricks with it.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:191pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Those early designers appear to have been in&#xfb02;uenced by experience with assemblers, in which</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:203pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">macro facilities were often the only device available for structuring programs.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:224pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">The strength of macro expansion is that it knows nothing about the underlying syntax of the base</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:236pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">language, and can be used to extend that syntax. Unfortunately, this power is very easily abused to</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:248pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">produce code that is opaque, surprising, and a fertile source of hard-to-characterize bugs.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:270pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">In C, the classic example of this sort of problem is a macro such as this:</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:303pt;left:72pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">#define max(x, y) x &gt; y ? x : y</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:334pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">There are at least two problems with this macro.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:334pt;left:280pt"><span style="font-family:Times,serif;font-size:9.963pt">One is that it can produce surprising results if</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:346pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">either of the arguments is an expression including an operator of lower precedence than</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> &gt;</span></tt><span style="font-family:Times,serif;font-size:9.963pt"> or</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> ?:</span></tt><span style="font-family:Times,serif;font-size:9.963pt">.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:358pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Consider the expression</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> max(a = b, ++c)</span></tt><span style="font-family:Times,serif;font-size:9.963pt">. If the programmer has forgotten that</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> max</span></tt><span style="font-family:Times,serif;font-size:9.963pt"> is a macro,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:370pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">he will be expecting the assignment</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> a = b</span></tt><span style="font-family:Times,serif;font-size:9.963pt"> and the preincrement operation on</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> c</span></tt><span style="font-family:Times,serif;font-size:9.963pt"> to be executed</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:381pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">before the resulting values are passed as arguments to</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> max</span></tt><span style="font-family:Times,serif;font-size:9.963pt">.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:403pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">But that&#x2019;s not what will happen. Instead, the preprocessor will expand this expression to</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> a = b &gt;</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:417pt;left:72pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">++c ?</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:417pt;left:109pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">a = b :</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:415pt;left:158pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">++c</span></tt><span style="font-family:Times,serif;font-size:9.963pt">, which the C compiler&#x2019;s precedence rules make it interpret as</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> a = (b &gt;</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:429pt;left:72pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">++c ?</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:429pt;left:109pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">a = b :</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:427pt;left:158pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">++c)</span></tt><span style="font-family:Times,serif;font-size:9.963pt">. The effect will be to assign to</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> a</span></tt><span style="font-family:Times,serif;font-size:9.963pt">!</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:449pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">This sort of bad interaction can be headed off by coding the macro de&#xfb01;nition more defensively.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:482pt;left:72pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">#define max(x, y) ((x) &gt; (y) ? (x) : (y))</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:512pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">With this de&#xfb01;nition, the expansion would be</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> ((a = b) &gt; (++c) ?</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:514pt;left:374pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">(a = b) :</span></tt></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:512pt;left:433pt"><tt><span style="font-family:Courier,monospace;font-size:8.966pt">(++c))</span></tt><span style="font-family:Times,serif;font-size:9.963pt">.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:524pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">This solves one problem &#x2014; but notice that</span><tt><span style="font-family:Courier,monospace;font-size:8.966pt"> c</span></tt><span style="font-family:Times,serif;font-size:9.963pt"> may be incremented twice! There are subtler versions</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:536pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">of this trap, such as passing the macro a function-call with side effects.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:581pt;left:262pt"><span style="font-family:Times,serif;font-size:9.963pt">246</span></p>
</div>
