<div id="page0" style="position:relative;width:540pt;height:648pt;background-color:white">
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:32pt;left:209pt"><span style="font-family:Times,serif;font-size:9.963pt">Chapter 7. Multiprogramming</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:100pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Another example can be found in Bernstein&#x2019;s</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail</span></i><span style="font-family:Times,serif;font-size:9.963pt"> package. It contains a program called</span><i><span style="font-family:Times,serif;font-size:9.963pt"> con-</span></i></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:112pt;left:72pt"><i><span style="font-family:Times,serif;font-size:9.963pt">dredirect</span></i><span style="font-family:Times,serif;font-size:9.963pt">. The &#xfb01;rst parameter is an email address, and the remainder a gatekeeper program and</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:124pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">arguments.</span><i><span style="font-family:Times,serif;font-size:9.963pt"> condredirect</span></i><span style="font-family:Times,serif;font-size:9.963pt"> forks and execs the gatekeeper with its arguments. If the gatekeeper exits</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:136pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">successfully,</span><i><span style="font-family:Times,serif;font-size:9.963pt"> condredirect</span></i><span style="font-family:Times,serif;font-size:9.963pt"> forwards the email pending on stdin to the speci&#xfb01;ed email address.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:136pt;left:459pt"><span style="font-family:Times,serif;font-size:9.963pt">In</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:148pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">this case, opposite to that of</span><i><span style="font-family:Times,serif;font-size:9.963pt"> rblsmtpd</span></i><span style="font-family:Times,serif;font-size:9.963pt">, the security decision is made by the child; this case is a bit</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:160pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">more like a classical shellout.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:181pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">A more elaborate example is the</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail</span></i><span style="font-family:Times,serif;font-size:9.963pt"> POP3 server. It consists of three programs,</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail-popup</span></i><span style="font-family:Times,serif;font-size:9.963pt">,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:193pt;left:72pt"><i><span style="font-family:Times,serif;font-size:9.963pt">checkpassword</span></i><span style="font-family:Times,serif;font-size:9.963pt">, and</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail-pop3d</span></i><span style="font-family:Times,serif;font-size:9.963pt">.</span><i><span style="font-family:Times,serif;font-size:9.963pt"> Checkpassword</span></i><span style="font-family:Times,serif;font-size:9.963pt"> comes from a separate package cleverly called</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:205pt;left:72pt"><i><span style="font-family:Times,serif;font-size:9.963pt">checkpassword</span></i><span style="font-family:Times,serif;font-size:9.963pt">, and unsurprisingly it checks the password. The POP3 protocol has an authentication</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:217pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">phase and mailbox phase; once you enter the mailbox phase you cannot go back to the authentication</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:229pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">phase. This is a perfect application for Bernstein chaining.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:251pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">The &#xfb01;rst parameter of</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail-popup</span></i><span style="font-family:Times,serif;font-size:9.963pt"> is the hostname to use in the POP3 prompts. The rest of its</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:263pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">parameters are forked and passed to exec(2), after the POP3 username and password have been</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:275pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">fetched. If the program returns failure, the password must be wrong, so</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail-popup</span></i><span style="font-family:Times,serif;font-size:9.963pt"> reports that</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:287pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">and waits for a different password. Otherwise, the program is presumed to have &#xfb01;nished the POP3</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:299pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">conversation, so</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail-popup</span></i><span style="font-family:Times,serif;font-size:9.963pt"> exits.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:321pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">The program named on</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail-popup</span></i><span style="font-family:Times,serif;font-size:9.963pt">&#x2019;s command line is expected to read three null-terminated</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:329pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">strings from &#xfb01;le descriptor 3.</span><sup><span style="font-family:Times,serif;font-size:6.273pt">72</span></sup><sup><span style="font-family:Times,serif;font-size:9.963pt"> </span></sup><span style="font-family:Times,serif;font-size:9.963pt">These are the username, password, and response to a cryptographic</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:345pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">challenge, if any.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:345pt;left:151pt"><span style="font-family:Times,serif;font-size:9.963pt">This time it&#x2019;s</span><i><span style="font-family:Times,serif;font-size:9.963pt"> checkpassword</span></i><span style="font-family:Times,serif;font-size:9.963pt"> which accepts as parameters the name of</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail-</span></i></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:357pt;left:72pt"><i><span style="font-family:Times,serif;font-size:9.963pt">pop3d</span></i><span style="font-family:Times,serif;font-size:9.963pt"> and its parameters. The</span><i><span style="font-family:Times,serif;font-size:9.963pt"> checkpassword</span></i><span style="font-family:Times,serif;font-size:9.963pt"> program exits with failure if the password does not</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:369pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">match; otherwise it changes to the user&#x2019;s uid, gid, and home directory, and executes the rest of its</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:381pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">command line on behalf of that user.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:403pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">Bernstein chaining is useful for situations in which the application needs setuid or setgid privileges to</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:415pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">initialize a connection, or to acquire some credential, and then drop those privileges so that following</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:427pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">code does not have to be trusted. Following the exec, the child program cannot set its real user ID</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:439pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">back to root. It&#x2019;s also more &#xfb02;exible than a single process, because you can modify the behavior of</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:450pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">the system by inserting another program into the chain.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:472pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">For example,</span><i><span style="font-family:Times,serif;font-size:9.963pt"> rblsmtpd</span></i><span style="font-family:Times,serif;font-size:9.963pt"> (mentioned above) can be inserted into a Bernstein chain, in between</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:484pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">tcpserver (from the</span><i><span style="font-family:Times,serif;font-size:9.963pt"> ucspi-tcp</span></i><span style="font-family:Times,serif;font-size:9.963pt"> package) and the real SMTP server, typically</span><i><span style="font-family:Times,serif;font-size:9.963pt"> qmail-smtpd</span></i><span style="font-family:Times,serif;font-size:9.963pt">. However,</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:496pt;left:72pt"><span style="font-family:Times,serif;font-size:9.963pt">it works with inetd(8) and</span><b><span style="font-family:Times,serif;font-size:9.963pt"> sendmail -bs</span></b><span style="font-family:Times,serif;font-size:9.963pt"> as well.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:516pt;left:72pt"><span style="font-family:Times,serif;font-size:5.018pt">72</span><i><span style="font-family:Times,serif;font-size:7.97pt">qmail-popup</span></i><span style="font-family:Times,serif;font-size:7.97pt">&#x2019;s standard input and standard output are the socket, and standard error (which will be &#xfb01;le descriptor 2) goes</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:525pt;left:72pt"><span style="font-family:Times,serif;font-size:7.97pt">to a log &#xfb01;le. File descriptor 3 is guaranteed to be the next to be allocated. As an infamous kernel comment once observed:</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:535pt;left:72pt"><span style="font-family:Times,serif;font-size:7.97pt">&#x201c;You are not expected to understand this&#x201d;.</span></p>
<p style="position:absolute;white-space:pre;margin:0;padding:0;top:581pt;left:262pt"><span style="font-family:Times,serif;font-size:9.963pt">199</span></p>
</div>
